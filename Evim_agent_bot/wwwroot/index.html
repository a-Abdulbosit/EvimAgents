<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Карта партнёрских магазинов</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
    <style>
        html, body, #map {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100vh;
            font-family: sans-serif;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const toRad = x => x * Math.PI / 180;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function getStatusText(status) {
            switch (status) {
                case 0: return '🕓 Новый';
                case 1: return '✅ Активен';
                case 2: return '❌ Неактивен';
                default: return '❓ Неизвестно';
            }
        }

        fetch('locations.json')
            .then(res => res.json())
            .then(locations => {
                ymaps.ready(() => {
                    const map = new ymaps.Map("map", {
                        center: [41.31, 69.28],
                        zoom: 11,
                        controls: ['zoomControl', 'fullscreenControl']
                    });

                    const groups = [];
                    locations.forEach(loc => {
                        let group = groups.find(g => getDistance(
                            g[0].Latitude, g[0].Longitude,
                            loc.Latitude, loc.Longitude
                        ) <= 70);

                        if (group) group.push(loc);
                        else groups.push([loc]);
                    });

                    groups.forEach(group => {
                        const lat = group[0].Latitude;
                        const lon = group[0].Longitude;

                        const content = group.map(loc => {
                            return `
                                    <b>🏪 ${loc.MarketName} #${loc.MarketNumber}</b><br>
                                    👤 Агент: ${loc.AgentName}<br>
                                    🕒 Добавлен: ${new Date(loc.CreatedAt).toLocaleString()}<br>
                                    📌 Статус: ${getStatusText(loc.Status)}<br>
                                    📝 Заметки: ${loc.Notes ?? 'Нет заметок'}
                                    <hr>
                                `;
                        }).join('');

                        const icon = group.length > 1
                            ? 'images/location-group.png'
                            : 'images/location-pin.png';

                        const placemark = new ymaps.Placemark(
                            [lat, lon],
                            { balloonContent: content },
                            {
                                iconLayout: 'default#image',
                                iconImageHref: icon,
                                iconImageSize: [30, 30],
                                iconImageOffset: [-15, -30]
                            }
                        );

                        map.geoObjects.add(placemark);
                    });
                });
            })
            .catch(err => {
                alert("❌ Не удалось загрузить местоположения.");
                console.error("Ошибка загрузки locations.json:", err);
            });
    </script>
</body>
</html>
